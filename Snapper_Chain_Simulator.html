<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Code Jam: Snapper Chain Simulator</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+JP:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .wire-glow {
            box-shadow: 0 0 10px #facc15, 0 0 20px #facc15;
        }
        .bulb-glow {
            filter: drop-shadow(0 0 15px #facc15);
        }
        /* スムーズなスクロール用 */
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Icons ---
        const Zap = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
            </svg>
        );

        const Lightbulb = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <line x1="9" y1="18" x2="15" y2="18"></line>
                <line x1="10" y1="22" x2="14" y2="22"></line>
                <path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 16.5 8 4.5 4.5 0 0 0 12 3.5 4.5 4.5 0 0 0 7.5 8c0 1.57.81 2.92 2 3.84a6.22 6.22 0 0 1 1.09 1.76"></path>
                <path d="M10 18h4"></path>
            </svg>
        );

        const Power = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
                <line x1="12" y1="2" x2="12" y2="12"></line>
            </svg>
        );

        const RotateCcw = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M3 2v6h6"></path>
                <path d="M3 13a9 9 0 1 0 3-7.7L3 8"></path>
            </svg>
        );

        const Info = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
        );

        const Settings = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
        );

        const Play = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
        );

        const Pause = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <rect x="6" y="4" width="4" height="16"></rect>
                <rect x="14" y="4" width="4" height="16"></rect>
            </svg>
        );

        const FastForward = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <polygon points="13 19 22 12 13 5 13 19"></polygon>
                <polygon points="2 19 11 12 2 5 2 19"></polygon>
            </svg>
        );
        // --- End of Icons ---

        // Individual Snapper Component
        const Snapper = ({ id, isOn, isPowered }) => {
            return (
                <div className="flex flex-col items-center mx-1 sm:mx-2 relative group">
                    {/* Wire Input (Left) */}
                    <div className={`absolute left-0 top-1/2 -translate-x-full w-4 sm:w-8 h-2 transition-colors duration-300 ${isPowered ? 'bg-yellow-400 wire-glow' : 'bg-gray-300'}`} />
                    
                    {/* The Snapper Box */}
                    <div 
                        className={`
                            relative w-10 h-10 sm:w-14 sm:h-14 rounded-lg border-4 flex items-center justify-center transition-all duration-300 shadow-md
                            ${isOn 
                                ? 'bg-green-100 border-green-500 text-green-700' 
                                : 'bg-gray-100 border-gray-400 text-gray-400'}
                        `}
                    >
                        <div className="flex flex-col items-center">
                            <span className="text-[10px] font-bold mb-0.5">S{id}</span>
                            <div className={`w-2.5 h-2.5 rounded-full ${isOn ? 'bg-green-500' : 'bg-gray-300'}`} />
                            <span className="text-[9px] mt-0.5 font-mono">{isOn ? 'ON(1)' : 'OFF(0)'}</span>
                        </div>
                        
                        {/* Internal State visualization (Switch) */}
                        <div className={`absolute -bottom-5 text-[10px] font-bold transition-opacity duration-300 whitespace-nowrap ${isPowered ? 'text-yellow-600 opacity-100' : 'text-gray-400 opacity-0'}`}>
                            {isPowered ? '⚡受電' : ''}
                        </div>
                    </div>
                </div>
            );
        };

        // Chain Visualization Component
        const SnapperChain = ({ n, k, isLatest }) => {
             const simulationState = useMemo(() => {
                const states = [];
                let powerReachesNext = true; 

                for (let i = 0; i < n; i++) {
                    const isOn = ((k >> i) & 1) === 1;
                    states.push({
                        id: i + 1,
                        isOn: isOn,
                        isPowered: powerReachesNext
                    });

                    if (!isOn) {
                        powerReachesNext = false;
                    }
                }
                return { snappers: states, bulbOn: powerReachesNext };
            }, [n, k]);

            return (
                <div className={`
                    relative rounded-xl p-4 sm:p-6 w-full max-w-full overflow-x-auto transition-all duration-500
                    ${isLatest ? 'bg-white shadow-xl border-2 border-blue-100 mb-8 scale-100' : 'bg-slate-50 border border-slate-200 mb-4 scale-95 opacity-80 hover:opacity-100'}
                `}>
                    <div className="absolute top-2 left-3 text-xs font-mono font-bold text-gray-400">
                        指を鳴らした回数: {k} {isLatest && <span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded ml-2">LATEST</span>}
                    </div>

                    <div className="flex items-center min-w-max justify-center py-2">
                        {/* Wall Power Socket */}
                        <div className="flex flex-col items-center mr-4 sm:mr-8 relative z-10">
                            <div className="w-10 h-14 bg-gray-800 rounded-lg flex items-center justify-center border-b-4 border-gray-900">
                                <Power className={`w-5 h-5 ${isLatest ? 'text-yellow-400' : 'text-yellow-600'}`} />
                            </div>
                        </div>

                        {/* Snappers Chain */}
                        <div className="flex items-center">
                            {simulationState.snappers.map((s) => (
                                <Snapper 
                                    key={s.id} 
                                    id={s.id} 
                                    isOn={s.isOn} 
                                    isPowered={s.isPowered} 
                                />
                            ))}
                        </div>

                        {/* Final Connection & Bulb */}
                        <div className="flex flex-col items-center ml-2 sm:ml-4 relative">
                            {/* Wire to bulb */}
                            <div className={`absolute right-full top-1/2 w-4 sm:w-8 h-2 -mr-1 transition-colors duration-300 ${simulationState.bulbOn ? 'bg-yellow-400 wire-glow' : 'bg-gray-300'}`} />
                            
                            <div className={`transition-all duration-300 ${simulationState.bulbOn ? 'scale-110' : 'scale-100 opacity-50'}`}>
                                <Lightbulb 
                                    width={48}
                                    height={48}
                                    className={`transition-colors duration-300 ${simulationState.bulbOn ? 'text-yellow-400 fill-yellow-400 bulb-glow' : 'text-gray-400'}`} 
                                />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [n, setN] = useState(4);
            const [history, setHistory] = useState([0]); 
            const [isAutoPlaying, setIsAutoPlaying] = useState(false);
            
            const bottomRef = useRef(null);
            const currentK = history[history.length - 1];
            
            // 最新のKをsetInterval内で参照するためのRef
            const currentKRef = useRef(currentK);
            useEffect(() => {
                currentKRef.current = currentK;
            }, [currentK]);

            // Handle N change
            const handleNChange = (e) => {
                const val = Math.max(1, Math.min(6, Number(e.target.value)));
                setN(val);
                setHistory([0]); 
                setIsAutoPlaying(false);
            };

            // Handle Single Snap
            const handleSnap = () => {
                setHistory(prev => {
                    const current = prev[prev.length - 1];
                    const newHistory = prev.length > 50 ? prev.slice(prev.length - 50) : prev;
                    return [...newHistory, current + 1];
                });
            };

            // Toggle Auto Snap to Next ON
            const handleAutoSnapToNext = () => {
                if (isAutoPlaying) {
                    setIsAutoPlaying(false);
                } else {
                    setIsAutoPlaying(true);
                }
            };

            // Reset
            const handleReset = () => {
                setHistory([0]);
                setIsAutoPlaying(false);
            };

            // Auto Play Effect (Modified logic)
            useEffect(() => {
                let interval;
                if (isAutoPlaying) {
                    interval = setInterval(() => {
                        // Refを使って最新のKを取得（クロージャ内の古い値を防ぐ）
                        const k = currentKRef.current;
                        const nextK = k + 1;
                        
                        // Check if nextK turns the light ON (all bits are 1)
                        const mask = Math.pow(2, n) - 1;
                        const isNextOn = (nextK & mask) === mask;
                        
                        // 次の状態がONなら、そこで停止フラグを立てる
                        // これにより、ON状態でスタートしても、まずOFFになってから次のONまで回る
                        if (isNextOn) {
                            setIsAutoPlaying(false);
                        }
                        
                        setHistory(prev => {
                            const newHistory = prev.length > 50 ? prev.slice(prev.length - 50) : prev;
                            return [...newHistory, nextK];
                        });
                    }, 100); // 100ms interval for fast playback
                }
                return () => clearInterval(interval);
            }, [isAutoPlaying, n]);

            // Auto scroll
            useEffect(() => {
                if (bottomRef.current) {
                    bottomRef.current.scrollIntoView({ behavior: 'smooth' });
                }
            }, [history]);

            const targetK = Math.pow(2, n) - 1;
            return (
                <div className="min-h-screen flex flex-col items-center bg-[#f0f4f8]">
                    
                    {/* Header & Controls (Sticky Wrapper) */}
                    <div className="sticky top-0 z-50 w-full flex flex-col items-center bg-[#f0f4f8]/95 backdrop-blur-md shadow-sm border-b border-gray-200/50 pt-3 sm:pt-4 pb-4 px-4 sm:px-8">
                        
                        {/* Title Header */}
                        <div className="max-w-4xl w-full text-center mb-3">
                            <div className="flex items-center justify-center gap-2 mb-0.5">
                                <Zap className="text-yellow-500 w-5 h-5 sm:w-6 sm:h-6 fill-current" />
                                <h1 className="text-xl sm:text-2xl font-bold text-gray-800">Snapper Chain Simulator</h1>
                            </div>
                            <p className="text-[10px] sm:text-xs text-gray-600">Google Code Jam 2010 - Problem A</p>
                        </div>

                        <div className="w-full max-w-2xl">
                            
                            {/* Control Panel (Compact Layout) */}
                            <div className="bg-white p-4 rounded-xl shadow-md">
                                <div className="flex items-center justify-between mb-3">
                                    <h2 className="text-sm font-bold text-gray-700 flex items-center gap-2">
                                        <Settings className="w-4 h-4" /> 操作パネル
                                    </h2>
                                    <div className="flex items-center gap-2">
                                        <span className="text-xs text-gray-500">スナッパー数(N):</span>
                                        <input 
                                            type="range" 
                                            min="1" 
                                            max="6" 
                                            value={n} 
                                            onChange={handleNChange}
                                            disabled={isAutoPlaying}
                                            className="w-24 h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600 disabled:opacity-50"
                                        />
                                        <span className="text-blue-600 font-bold text-sm w-4 text-center">{n}</span>
                                    </div>
                                </div>
                                
                                <div className="flex gap-3 mb-3">
                                    <button 
                                        onClick={handleSnap}
                                        disabled={isAutoPlaying}
                                        className="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white font-bold py-2.5 px-2 rounded-lg shadow-sm active:transform active:scale-95 transition-all flex flex-col items-center justify-center gap-0.5 min-h-[60px]"
                                    >
                                        <div className="flex items-center gap-1">
                                            <Zap className="fill-white w-4 h-4" /> 
                                            <span className="text-sm">指を1回鳴らす</span>
                                        </div>
                                        <span className="text-[10px] font-normal opacity-80">+1 SNAP!</span>
                                    </button>

                                    <button 
                                        onClick={handleAutoSnapToNext}
                                        className={`flex-1 font-bold py-2.5 px-2 rounded-lg shadow-sm active:transform active:scale-95 transition-all flex flex-col items-center justify-center gap-0.5 min-h-[60px]
                                            ${isAutoPlaying 
                                                ? 'bg-red-50 text-red-600 border border-red-200 hover:bg-red-100' 
                                                : 'bg-green-50 text-green-700 border border-green-200 hover:bg-green-100'
                                            }`}
                                    >
                                        <div className="flex items-center gap-1">
                                            {isAutoPlaying ? <Pause className="w-4 h-4" /> : <FastForward className="w-4 h-4" />}
                                            <span className="text-sm">{isAutoPlaying ? '停止' : '自動実行'}</span>
                                        </div>
                                        <span className="text-[10px] font-normal opacity-80">{isAutoPlaying ? '連鎖を止める' : '次の点灯まで進む'}</span>
                                    </button>
                                </div>

                                <div className="flex items-center justify-between border-t border-gray-100 pt-3">
                                    <div className="text-xs text-gray-500 flex items-center gap-2">
                                        現在の回数(K): 
                                        <span className="font-mono font-bold text-gray-700 text-lg">{currentK}</span>
                                    </div>
                                    <button 
                                        onClick={handleReset}
                                        disabled={isAutoPlaying}
                                        className="bg-gray-100 hover:bg-red-50 hover:text-red-600 hover:border-red-200 border border-gray-200 text-gray-600 font-bold py-1.5 px-3 rounded text-xs transition-colors flex items-center justify-center gap-1.5 disabled:opacity-50"
                                    >
                                        <RotateCcw className="w-3 h-3" /> 最初から
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Simulation History List */}
                    <div className="w-full px-4 sm:px-8 mt-4 pb-10">
                        <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-2 max-w-7xl mx-auto w-full">
                            <h3 className="text-lg font-bold text-gray-700 flex items-center">
                                <div className="flex items-center">
                                    <span className="bg-gray-200 text-gray-600 rounded-full w-6 h-6 flex items-center justify-center mr-2 text-xs">{history.length}</span>
                                    履歴ログ (History)
                                </div>
                            </h3>
                            <div className="flex items-center gap-2 w-full sm:w-auto">
                                <span className="text-[10px] text-gray-400 font-normal mr-2 hidden sm:inline">※最新50件まで表示</span>
                            </div>
                        </div>
                        
                        <div className="flex flex-col items-center pb-20 w-full">
                            {history.map((histK, index) => (
                                <SnapperChain 
                                    key={`${index}-${histK}`} 
                                    n={n} 
                                    k={histK} 
                                    isLatest={index === history.length - 1} 
                                />
                            ))}
                            <div ref={bottomRef} />
                        </div>
                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>